{% extends "base.html" %}
{% block content %}
<section class="page-hero">
  <h1 class="page-title">Threat Detection</h1>
  <p class="page-subtitle">
    Upload your CSV and run predictions with a trained model.
    If your file includes a <code>label</code>, <code>class</code>, or <code>target</code> column,
    we’ll also compute accuracy, a classification report, and confusion matrices.
  </p>
</section>

<div class="detect-layout">
  <!-- Left: Form -->
  <div class="panel glass">
    <div class="panel-header">
      <i class="fas fa-shield-virus"></i>
      <h2 class="panel-title">Run Detection</h2>
    </div>

    <form method="post"
          action="{{ url_for('detect') }}"
          enctype="multipart/form-data"
          class="detect-form fancy-form"
          id="detectForm">
      <div class="form-row">
         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label for="model_name">Choose Model</label>
        <select name="model_name" id="model_name" class="input select" required>
          {% for m in models %}
            <option value="{{ m }}">{{ m|replace('-', ' ')|title }}</option>
          {% endfor %}
          {% if not models %}
            <option disabled selected>No models available — ask an admin to train one.</option>
          {% endif %}
        </select>
        {% if not models and has_admin_models %}
          <div class="smallnote">
            <a class="btn btn-xs" href="{{ url_for('admin_train') }}">
              <i class="fas fa-hammer"></i> Train a model
            </a>
          </div>
        {% endif %}
      </div>

      <div class="form-row">
        <label for="testfile">Upload CSV</label>
        <div class="filebox" id="filebox">
          <input id="testfile" name="testfile" type="file" accept=".csv" required>
          <label for="testfile">
            <i class="fas fa-cloud-upload-alt"></i>
            <span class="filebox-title">Drag & drop or click to upload</span>
            <span class="filebox-sub">
              CSV only • Tip: use the same columns the model was trained on.
            </span>
            <span class="filebox-name" id="fileName">No file selected</span>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-cta btn-lg" type="submit" id="runBtn">
          <i class="fas fa-play-circle"></i> Run Detection
        </button>
      </div>
    </form>

    <div class="form-tip">
      <i class="fas fa-info-circle"></i>
      <span>
        <strong>Labeled data?</strong> Include a <code>label</code> (or <code>class</code>/<code>target</code>) column to get
        Accuracy, Classification Report, and Confusion Matrices. Without labels, we’ll generate predictions and show
        confidence & distribution charts.
      </span>
    </div>
    <div class="form-tip">
      <i class="fas fa-info-circle"></i>
      <span>
        Some charts (ROC/PR, calibration) require models with <code>predict_proba</code>. If the chosen model
        doesn’t support probabilities, those charts will be omitted automatically.
      </span>
    </div>
  </div>

  <!-- Right: Helpful notes -->
  <aside class="panel tips">
    <div class="panel-header">
      <i class="fas fa-lightbulb"></i>
      <h3 class="panel-title">Tips for best results</h3>
    </div>
    <ul class="tip-list">
      <li><i class="fas fa-check"></i> Column names should match what the model saw during training (extra columns are OK; missing ones are filled with <code>0</code>).</li>
      <li><i class="fas fa-check"></i> Categorical columns are automatically one-hot encoded.</li>
      <li><i class="fas fa-check"></i> Missing values are filled with <code>0</code> by default.</li>
      <li><i class="fas fa-check"></i> Include a <code>label</code> column to get full evaluation metrics.</li>
    </ul>

    {% if models %}
    <div class="smallnote">
      <strong>Available models:</strong>
      {% for m in models %}
        <span class="tag">{{ m }}</span>
      {% endfor %}
    </div>
    {% endif %}
  </aside>
</div>

<script>
  (function () {
    const input = document.getElementById('testfile');
    const nameOut = document.getElementById('fileName');
    const filebox = document.getElementById('filebox');
    const runBtn = document.getElementById('runBtn');
    const modelSelect = document.getElementById('model_name');
    const form = document.getElementById('detectForm');

    // Disable submit if there are no models
    if (modelSelect && modelSelect.options.length === 1 && modelSelect.options[0].disabled) {
      runBtn.setAttribute('disabled', 'disabled');
      runBtn.title = 'No models available';
    }

    // Show chosen file name
    if (input && nameOut) {
      input.addEventListener('change', function () {
        nameOut.textContent = (this.files && this.files[0]) ? this.files[0].name : 'No file selected';
      });
    }

    // Drag-over visual state
    if (filebox) {
      ['dragenter', 'dragover'].forEach(ev => filebox.addEventListener(ev, e => {
        e.preventDefault(); filebox.classList.add('dragging');
      }));
      ['dragleave', 'drop'].forEach(ev => filebox.addEventListener(ev, e => {
        e.preventDefault(); filebox.classList.remove('dragging');
      }));
    }

    // Light client-side guard: CSV only
    if (form) {
      form.addEventListener('submit', function (e) {
        if (!input || !input.files || !input.files[0]) return;
        const name = input.files[0].name.toLowerCase();
        if (!name.endsWith('.csv')) {
          e.preventDefault();
          alert('Please upload a .csv file.');
        }
      });
    }
  })();
</script>
{% endblock %}
