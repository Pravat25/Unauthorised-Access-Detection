{% extends "base.html" %}
{% block content %}
<h1>Threat Detection Results</h1>

<div class="results-grid">
  <div class="metric">
    <div class="metric-title">Accuracy</div>
    <div class="metric-value">{{ '%.2f'|format(accuracy * 100) }}%</div>
    <p class="muted smallnote">Calculated from your uploaded labeled dataset.</p>
  </div>

  {% if macro_ap is not none %}
  <div class="metric">
    <div class="metric-title">Macro Average Precision (PR)</div>
    <div class="metric-value">{{ '%.2f'|format(macro_ap * 100) }}%</div>
    <p class="muted smallnote">Area under Precision–Recall across classes.</p>
  </div>
  {% endif %}

  {% if conf_bands %}
  <div class="metric">
    <div class="metric-title">Prediction Confidence Bands</div>
    <div class="metric-value">
      <div>High (≥0.9): <strong>{{ conf_bands.high }}</strong></div>
      <div>Medium (0.6–0.9): <strong>{{ conf_bands.medium }}</strong></div>
      <div>Low (&lt;0.6): <strong>{{ conf_bands.low }}</strong></div>
    </div>
  </div>
  {% endif %}
</div>

{% if validation_reports %}
<hr>
<h3>Validation Reports</h3>
<ul class="list-unstyled">
  {% for fname in validation_reports %}
    <li>
      <a href="{{ url_for('download_report', filename=fname) }}" target="_blank" rel="noopener">
        {{ fname }}
      </a>
    </li>
  {% endfor %}
</ul>
{% endif %}

<h3>Confusion Matrices</h3>
<div class="results-grid">
  <div class="metric">
    <div class="metric-title">Raw Counts</div>
    <div class="metric-value">
      {% if charts.cm %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.cm) }}" alt="Confusion matrix">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Normalized (%)</div>
    <div class="metric-value">
      {% if charts.cm_norm %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.cm_norm) }}" alt="Confusion matrix normalized">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Predicted Class Mix</div>
    <div class="metric-value">
      {% if charts.pred_pie %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.pred_pie) }}" alt="Predicted class pie">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
</div>

<h3>Quality & Diagnostics</h3>
<div class="results-grid">
  <div class="metric">
    <div class="metric-title">Per-class Precision / Recall / F1</div>
    <div class="metric-value">
      {% if charts.prf %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.prf) }}" alt="PRF bars">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Top Misclassifications</div>
    <div class="metric-value">
      {% if charts.misclass %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.misclass) }}" alt="Misclass bars">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Support vs Recall</div>
    <div class="metric-value">
      {% if charts.supp_recall %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.supp_recall) }}" alt="Support vs Recall">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">True-class Probability (by label)</div>
    <div class="metric-value">
      {% if charts.trueproba %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.trueproba) }}" alt="True-class probability histograms">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">ROC (macro)</div>
    <div class="metric-value">
      {% if charts.roc %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.roc) }}" alt="ROC macro">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Calibration (Reliability)</div>
    <div class="metric-value">
      {% if charts.calib %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.calib) }}" alt="Reliability plot">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Confidence Histogram</div>
    <div class="metric-value">
      {% if charts.confhist %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.confhist) }}" alt="Confidence histogram">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
  {% if charts.gains or charts.lift or charts.ks %}
  <div class="metric">
    <div class="metric-title">Cumulative Gains (Binary)</div>
    <div class="metric-value">
      {% if charts.gains %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.gains) }}" alt="Gains curve">
      {% else %}<span class="muted">Binary only / Not available</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">Lift Curve (Binary)</div>
    <div class="metric-value">
      {% if charts.lift %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.lift) }}" alt="Lift curve">
      {% else %}<span class="muted">Binary only / Not available</span>{% endif %}
    </div>
  </div>
  <div class="metric">
    <div class="metric-title">KS Statistic (Binary)</div>
    <div class="metric-value">
      {% if charts.ks %}
        <img class="conf-matrix" src="{{ url_for('static', filename=charts.ks) }}" alt="KS curve">
      {% else %}<span class="muted">Binary only / Not available</span>{% endif %}
    </div>
  </div>
  {% endif %}
  <div class="metric">
    <div class="metric-title">Feature Importance (top 15)</div>
    <div class="metric-value">
      {% if feat_img %}
        <img class="conf-matrix" src="{{ url_for('static', filename=feat_img) }}" alt="Feature importance">
      {% else %}<span class="muted">N/A</span>{% endif %}
    </div>
  </div>
</div>

<h3>Classification Report</h3>
{% if report %}
  <pre class="report">{{ report }}</pre>
{% else %}
  <p class="muted">No report available.</p>
{% endif %}

<a class="btn" href="{{ url_for('dashboard') }}">⬅ Back to Dashboard</a>
{% endblock %}
